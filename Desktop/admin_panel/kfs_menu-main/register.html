<!DOCTYPE html>
<html lang="uz">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
  <title>Ro'yxatdan o'tish</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #F5F5F5;
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }

    .reg-header {
      background: linear-gradient(135deg, #FAB95B 0%, #F5A53A 100%);
      padding: 3rem 1.5rem 2rem;
      text-align: center;
      position: relative;
    }

    .reg-header::after {
      content: '';
      position: absolute;
      bottom: -20px;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 40px;
      background: #F5F5F5;
      border-radius: 50%;
    }

    .reg-logo {
      font-size: 3rem;
      margin-bottom: 0.75rem;
    }

    .reg-brand {
      font-size: 1.5rem;
      font-weight: 900;
      color: #fff;
      letter-spacing: -0.5px;
      margin-bottom: 0.2rem;
    }

    .reg-tagline {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.85);
      margin-top: 0.25rem;
    }

    .reg-content {
      flex: 1;
      padding: 2.5rem 1.25rem 2rem;
      max-width: 480px;
      margin: 0 auto;
      width: 100%;
    }

    /* Steps */
    .steps {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 2rem;
    }

    .step-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #E0E0E0;
      color: #999;
      font-size: 0.8rem;
      font-weight: 800;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      flex-shrink: 0;
    }

    .step-dot.active {
      background: #FAB95B;
      color: #fff;
      box-shadow: 0 0 0 4px rgba(250, 185, 91, 0.2);
    }

    .step-dot.done {
      background: #4CAF50;
      color: #fff;
    }

    .step-line {
      height: 2px;
      width: 40px;
      background: #E0E0E0;
      transition: background 0.3s;
    }

    .step-line.done {
      background: #4CAF50;
    }

    .reg-card {
      background: #fff;
      border-radius: 20px;
      padding: 1.75rem 1.25rem;
      box-shadow: 0 2px 16px rgba(0, 0, 0, 0.06);
    }

    .card-icon {
      font-size: 2.5rem;
      text-align: center;
      margin-bottom: 0.75rem;
      color: #FAB95B;
      display: flex;
      justify-content: center;
    }

    .card-title {
      font-size: 1.2rem;
      font-weight: 800;
      color: #202124;
      text-align: center;
      margin-bottom: 0.4rem;
    }

    .card-sub {
      font-size: 0.83rem;
      color: #888;
      text-align: center;
      margin-bottom: 1.5rem;
      line-height: 1.5;
    }

    .input-group {
      margin-bottom: 1rem;
    }

    .input-label {
      font-size: 0.78rem;
      font-weight: 700;
      color: #555;
      margin-bottom: 0.4rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: block;
    }

    .input-wrap {
      display: flex;
      align-items: center;
      background: #F5F5F5;
      border-radius: 14px;
      border: 2px solid transparent;
      padding: 0 1rem;
      transition: all 0.2s;
    }

    .input-wrap:focus-within {
      border-color: #FAB95B;
      background: #fff;
    }

    .input-prefix {
      font-size: 1rem;
      font-weight: 700;
      color: #202124;
      flex-shrink: 0;
      margin-right: 0.3rem;
    }

    .input-wrap input {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 1rem;
      font-weight: 600;
      color: #202124;
      outline: none;
      padding: 0.85rem 0;
      width: 100%;
    }

    .single-input {
      width: 100%;
      background: #F5F5F5;
      border-radius: 14px;
      border: 2px solid transparent;
      padding: 0.85rem 1rem;
      font-size: 1rem;
      font-weight: 600;
      color: #202124;
      outline: none;
      transition: all 0.2s;
    }

    .single-input:focus {
      border-color: #FAB95B;
      background: #fff;
    }

    .otp-container {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 1rem;
    }

    .otp-digit {
      width: 48px;
      height: 48px;
      border: 2px solid #E0E0E0;
      border-radius: 12px;
      font-size: 1.5rem;
      font-weight: 700;
      text-align: center;
      outline: none;
      color: #202124;
      background: #F5F5F5;
      transition: border-color 0.2s, background 0.2s;
      padding: 0;
    }

    .otp-digit:focus {
      border-color: #FAB95B;
      background: #fff;
    }

    .btn-primary {
      width: 100%;
      padding: 1rem;
      background: #FAB95B;
      color: #fff;
      border: none;
      border-radius: 14px;
      font-size: 1rem;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary:active {
      transform: scale(0.98);
      opacity: 0.9;
    }

    .btn-primary:disabled {
      opacity: 0.5;
    }

    .error-msg {
      font-size: 0.8rem;
      color: #E53935;
      text-align: center;
      min-height: 1.1rem;
      margin: 0.4rem 0;
    }

    .success-msg {
      font-size: 0.82rem;
      color: #4CAF50;
      text-align: center;
      font-weight: 600;
      margin-bottom: 0.75rem;
    }

    .resend-btn {
      text-align: center;
      font-size: 0.82rem;
      color: #FAB95B;
      cursor: pointer;
      margin-top: 0.75rem;
      font-weight: 600;
      text-decoration: underline;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .timer-txt {
      text-align: center;
      font-size: 0.8rem;
      color: #999;
      margin-top: 0.5rem;
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0);
      }

      25% {
        transform: translateX(-6px);
      }

      75% {
        transform: translateX(6px);
      }
    }

    .shake {
      animation: shake 0.3s ease-in-out;
    }

    .step-panel {
      display: none;
    }

    .step-panel.active {
      display: block;
    }

    .back-link {
      text-align: center;
      margin-bottom: 1rem;
    }

    .back-link a {
      color: #888;
      font-size: 0.85rem;
      text-decoration: none;
    }

    .switch-link {
      text-align: center;
      margin-top: 1.5rem;
      font-size: 0.9rem;
      color: #666;
    }

    .switch-link a {
      color: #FAB95B;
      font-weight: 700;
      text-decoration: none;
    }
  </style>
</head>

<body>

  <div class="reg-header">
    <button onclick="handleBack()"
      style="position:absolute;top:1rem;left:1rem;background:rgba(255,255,255,0.25);border:none;border-radius:50%;width:38px;height:38px;display:flex;align-items:center;justify-content:center;cursor:pointer;">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
        <path d="M19 12H5M5 12l7 7M5 12l7-7" />
      </svg>
    </button>
    <div class="reg-logo">üçó</div>
    <div class="reg-brand">KFC Riston</div>
    <div class="reg-tagline">Tez va mazali taom yetkazish</div>
  </div>

  <div class="reg-content">

    <!-- Steps indicator (dinamik) ‚Äî endi display:none yo'q -->
    <div class="steps" id="stepsProgress"></div>

    <div class="reg-card">

      <!-- SIGNUP ‚Äî 1/3: Telefon raqam (Asosiy sahifa) -->
      <div class="step-panel active" id="panel-home">
        <div class="card-icon" style="margin-bottom:1.5rem;">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="8.5" cy="7" r="4"></circle>
            <line x1="20" y1="8" x2="20" y2="14"></line>
            <line x1="23" y1="11" x2="17" y2="11"></line>
          </svg>
        </div>
        <div class="card-title" style="font-size:1.4rem; margin-bottom:0.5rem;">Ro'yxatdan o'tish</div>
        <div class="card-sub" style="margin-bottom:1.5rem;">Telefon raqamingizni kiriting</div>

        <div class="input-group">
          <label class="input-label">Telefon raqam</label>
          <div class="input-wrap">
            <span class="input-prefix">+998</span>
            <input type="tel" id="signup-phone" placeholder="90 123 45 67" maxlength="12" inputmode="numeric"
              oninput="this.value=this.value.replace(/[^0-9 ]/g,'')" onkeydown="if(event.key==='Enter') signupStart()">
          </div>
        </div>

        <div class="error-msg" id="signup-phone-err"></div>

        <div id="signup-tgBotMsg"
          style="display:none; background:#FFF3E0; border-radius:12px; padding:1rem 1.1rem; margin-bottom:0.75rem; font-size:0.88rem; color:#BF360C; line-height:1.7; border:1.5px solid #FFCCBC;">
          ‚ö†Ô∏è <b>Telefon raqam botda saqlanmagan!</b><br><br>
          Avval <a href="https://t.me/demo_kfs_menu_bot" target="_blank"
            style="color:#1565C0;font-weight:700;">@demo_kfs_menu_bot</a> ga boring va raqamingizni yuboring.
        </div>

        <button class="btn-primary" id="signup-start-btn" onclick="signupStart()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
          Telegram orqali kod olish
        </button>

        <div class="switch-link">
          Hisobingiz bormi? <a href="javascript:void(0)" onclick="goLogin()">Kirish</a>
        </div>
      </div>

      <!-- SIGNUP ‚Äî 2/3: Verify code -->
      <div class="step-panel" id="panel-signup-otp">
        <div class="card-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
            stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
          </svg>
        </div>
        <div class="card-title">Kodni kiriting</div>
        <div class="success-msg" id="signup-otp-msg"></div>
        <div class="card-sub" style="margin-top:-0.75rem;">Telegram ga yuborilgan 6 xonali kodni kiriting</div>

        <div class="otp-container" id="signup-otp-container">
          <input type="tel" class="otp-digit" maxlength="1" inputmode="numeric">
          <input type="tel" class="otp-digit" maxlength="1" inputmode="numeric">
          <input type="tel" class="otp-digit" maxlength="1" inputmode="numeric">
          <input type="tel" class="otp-digit" maxlength="1" inputmode="numeric">
          <input type="tel" class="otp-digit" maxlength="1" inputmode="numeric">
          <input type="tel" class="otp-digit" maxlength="1" inputmode="numeric">
        </div>

        <div class="error-msg" id="signup-otp-err"></div>
        <button class="btn-primary" id="signup-verify-btn" onclick="signupVerify()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
            stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          Tasdiqlash
        </button>
        <div class="resend-btn" id="signup-resend-btn" style="display:none" onclick="signupResend()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
            stroke-linecap="round" stroke-linejoin="round">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
          </svg>
          Qaytadan yuborish
        </div>
        <div class="timer-txt" id="signup-timer"></div>

        <div class="back-link" style="margin-top:1rem;">
          <a href="javascript:void(0)" onclick="goHome()">‚Üê Orqaga</a>
        </div>
      </div>

      <!-- SIGNUP ‚Äî 3/3: Ism / Familya -->
      <div class="step-panel" id="panel-signup-name">
        <div class="card-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
        </div>
        <div class="card-title">Ismingizni kiriting</div>
        <div class="card-sub">Bu ma'lumot buyurtma uchun ishlatiladi</div>

        <div class="input-group">
          <label class="input-label">Ism</label>
          <input type="text" class="single-input" id="firstName" placeholder="Masalan: Abdulloh"
            autocomplete="given-name" onkeydown="if(event.key==='Enter') document.getElementById('lastName').focus()">
        </div>
        <div class="input-group">
          <label class="input-label">Familya</label>
          <input type="text" class="single-input" id="lastName" placeholder="Masalan: Karimov"
            autocomplete="family-name" onkeydown="if(event.key==='Enter') saveProfile()">
        </div>

        <div class="error-msg" id="signup-name-err"></div>
        <button class="btn-primary" onclick="saveProfile()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
            stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          Tasdiqlash va boshlash
        </button>
      </div>

      <!-- LOGIN ‚Äî 1/2: Telefon raqam -->
      <div class="step-panel" id="panel-login-phone">
        <div class="card-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
            <polyline points="10 17 15 12 10 7"></polyline>
            <line x1="15" y1="12" x2="3" y2="12"></line>
          </svg>
        </div>
        <div class="card-title">Kirish</div>
        <div class="card-sub">Telefon raqamingizni kiriting</div>

        <div class="input-group">
          <label class="input-label">Telefon raqam</label>
          <div class="input-wrap">
            <span class="input-prefix">+998</span>
            <input type="tel" id="login-phone" placeholder="90 123 45 67" maxlength="12" inputmode="numeric"
              oninput="this.value=this.value.replace(/[^0-9 ]/g,'')" onkeydown="if(event.key==='Enter') loginSendOTP()">
          </div>
        </div>

        <div class="error-msg" id="login-phone-err"></div>
        <div id="login-tgBotMsg"
          style="display:none; background:#FFF3E0; border-radius:12px; padding:1rem 1.1rem; margin-bottom:0.75rem; font-size:0.88rem; color:#BF360C; line-height:1.7; border:1.5px solid #FFCCBC;">
          <b>Telefon raqam botda saqlanmagan!</b><br><br>
          Avval <a href="https://t.me/demo_kfs_menu_bot" target="_blank"
            style="color:#1565C0;font-weight:700;">@demo_kfs_menu_bot</a> ga boring va raqamingizni yuboring.
        </div>

        <button class="btn-primary" id="login-send-btn" onclick="loginSendOTP()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
          Telegram orqali kod olish
        </button>

        <div class="switch-link">
          Hisobingiz yo'qmi? <a href="javascript:void(0)" onclick="goHome()">Ro'yxatdan o'tish</a>
        </div>
      </div>

      <!-- LOGIN ‚Äî 2/2: Verify code -->
      <div class="step-panel" id="panel-login-otp">
        <div class="card-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
            stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
          </svg>
        </div>
        <div class="card-title">Kodni kiriting</div>
        <div class="success-msg" id="login-otp-msg"></div>
        <div class="card-sub" style="margin-top:-0.75rem;">Telegram ga yuborilgan 6 xonali kodni kiriting</div>

        <div class="otp-container" id="login-otp-container">
          <input type="tel" class="otp-digit" maxlength="1" inputmode="numeric">
          <input type="tel" class="otp-digit" maxlength="1" inputmode="numeric">
          <input type="tel" class="otp-digit" maxlength="1" inputmode="numeric">
          <input type="tel" class="otp-digit" maxlength="1" inputmode="numeric">
          <input type="tel" class="otp-digit" maxlength="1" inputmode="numeric">
          <input type="tel" class="otp-digit" maxlength="1" inputmode="numeric">
        </div>

        <div class="error-msg" id="login-otp-err"></div>
        <button class="btn-primary" id="login-verify-btn" onclick="loginVerify()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
            stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          Tasdiqlash
        </button>
        <div class="resend-btn" id="login-resend-btn" style="display:none" onclick="loginResend()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
            stroke-linecap="round" stroke-linejoin="round">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
          </svg>
          Qaytadan yuborish
        </div>
        <div class="timer-txt" id="login-timer"></div>

        <div class="back-link" style="margin-top:1rem;">
          <a href="javascript:void(0)" onclick="goLoginPhone()">‚Üê Orqaga</a>
        </div>
      </div>

    </div>
  </div>

  <script>
    const API_URL = 'https://kfc-backend-kfcprojectrishton-e94b2235.koyeb.app';
    let verifiedPhone = null;

    const ICON_SEND = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>';
    const ICON_CHECK = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';

    let signupTimer = null;
    let loginTimer = null;

    function showPanel(id) {
      document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function renderSteps(mode, current) {
      const wrap = document.getElementById('stepsProgress');
      const total = mode === 'signup' ? 3 : 2;
      wrap.style.display = 'flex';
      wrap.innerHTML = '';
      for (let i = 1; i <= total; i++) {
        const dot = document.createElement('div');
        dot.className = 'step-dot' + (i < current ? ' done' : i === current ? ' active' : '');
        dot.textContent = i < current ? '‚úî' : i;
        wrap.appendChild(dot);
        if (i < total) {
          const line = document.createElement('div');
          line.className = 'step-line' + (i < current ? ' done' : '');
          wrap.appendChild(line);
        }
      }
    }

    function hideSteps() {
      document.getElementById('stepsProgress').style.display = 'none';
    }

    function goHome() {
      showPanel('panel-home');
      renderSteps('signup', 1);
      document.getElementById('signup-phone').value = '';
      document.getElementById('signup-phone-err').innerHTML = '';
      document.getElementById('signup-tgBotMsg').style.display = 'none';
      document.getElementById('signup-start-btn').disabled = false;
      document.getElementById('signup-start-btn').innerHTML = ICON_SEND + ' Telegram orqali kod olish';
    }

    function goLogin() {
      document.getElementById('login-phone').value = '';
      document.getElementById('login-phone-err').textContent = '';
      document.getElementById('login-tgBotMsg').style.display = 'none';
      document.getElementById('login-send-btn').disabled = false;
      document.getElementById('login-send-btn').innerHTML = ICON_SEND + ' Telegram orqali kod olish';
      renderSteps('login', 1);
      showPanel('panel-login-phone');
      setTimeout(() => document.getElementById('login-phone').focus(), 300);
    }

    function goLoginPhone() {
      if (loginTimer) clearInterval(loginTimer);
      renderSteps('login', 1);
      showPanel('panel-login-phone');
    }

    function startTimer(timerKey, timerTxtId, resendBtnId) {
      let secs = 60;
      const txt = document.getElementById(timerTxtId);
      const btn = document.getElementById(resendBtnId);
      btn.style.display = 'none';
      txt.textContent = `${secs} soniyadan keyin qayta yuborish`;
      if (window[timerKey]) clearInterval(window[timerKey]);
      window[timerKey] = setInterval(() => {
        secs--;
        if (secs <= 0) {
          clearInterval(window[timerKey]);
          txt.textContent = '';
          btn.style.display = 'flex';
        } else {
          txt.textContent = `${secs} soniyadan keyin qayta yuborish`;
        }
      }, 1000);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SIGNUP FLOW
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    async function signupStart() {
      const raw = document.getElementById('signup-phone').value.replace(/\D/g, '');
      document.getElementById('signup-phone-err').innerHTML = '';
      document.getElementById('signup-tgBotMsg').style.display = 'none';

      if (raw.length < 9) {
        document.getElementById('signup-phone-err').textContent = "Telefon raqamni to'liq kiriting";
        return;
      }

      const phone = '+998' + raw.slice(-9);
      verifiedPhone = phone;

      const btn = document.getElementById('signup-start-btn');
      btn.disabled = true;
      btn.textContent = 'Tekshirilmoqda...';

      // ‚îÄ‚îÄ 1. Avval telefon raqami mavjudligini tekshir ‚îÄ‚îÄ
      try {
        const checkRes = await fetch(`${API_URL}/api/check-phone?phone=${encodeURIComponent(phone)}`);
        const checkData = await checkRes.json();
        if (checkData.exists) {
          document.getElementById('signup-phone-err').innerHTML =
            "<span style='color:#E53935;font-weight:700;'>Siz allaqachon ro'yxatdan o'tgansiz.</span> " +
            "<a href='javascript:void(0)' onclick='goLogin()' style='color:#FAB95B;font-weight:700;text-decoration:underline;'>Kirish ‚Üí</a>";
          btn.disabled = false;
          btn.innerHTML = ICON_SEND + ' Telegram orqali kod olish';
          return;
        }
      } catch (e) {
        // check-phone ishlamasa ‚Äî davom et
      }

      btn.textContent = 'Yuborilmoqda...';

      try {
        const res = await fetch(`${API_URL}/api/otp/send`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone, mode: 'signup' })
        });
        const data = await res.json();
        const errMsg = getErrMsg(data);
        const isNotReg = res.status === 404 || errMsg.includes('not_registered');

        if (res.ok) {
          clearOtp('signup-otp-container');
          document.getElementById('signup-otp-err').textContent = '';
          document.getElementById('signup-verify-btn').disabled = false;
          document.getElementById('signup-verify-btn').innerHTML = ICON_CHECK + ' Tasdiqlash';
          renderSteps('signup', 2);
          showPanel('panel-signup-otp');
          startTimer('signupTimer', 'signup-timer', 'signup-resend-btn');
          setTimeout(() => document.querySelector('#signup-otp-container input').focus(), 300);
        } else if (res.status === 400 && (errMsg.includes('exists') || errMsg.includes('user_already'))) {
          // Backend dan ham double-check
          document.getElementById('signup-phone-err').innerHTML =
            "<span style='color:#E53935;font-weight:700;'>Siz allaqachon ro'yxatdan o'tgansiz.</span> " +
            "<a href='javascript:void(0)' onclick='goLogin()' style='color:#FAB95B;font-weight:700;text-decoration:underline;'>Kirish ‚Üí</a>";
          btn.disabled = false;
          btn.innerHTML = ICON_SEND + ' Telegram orqali kod olish';
        } else if (isNotReg) {
          document.getElementById('signup-tgBotMsg').style.display = 'block';
          document.getElementById('signup-tgBotMsg').scrollIntoView({ behavior: 'smooth' });
          btn.disabled = false;
          btn.innerHTML = ICON_SEND + ' Telegram orqali kod olish';
        } else if (res.status === 429) {
          clearOtp('signup-otp-container');
          document.getElementById('signup-otp-err').textContent = '';
          document.getElementById('signup-verify-btn').disabled = false;
          document.getElementById('signup-verify-btn').innerHTML = ICON_CHECK + ' Tasdiqlash';
          renderSteps('signup', 2);
          showPanel('panel-signup-otp');
          startTimer('signupTimer', 'signup-timer', 'signup-resend-btn');
          setTimeout(() => document.querySelector('#signup-otp-container input').focus(), 300);
        } else {
          document.getElementById('signup-phone-err').textContent = errMsg || 'Xato. Qayta urining.';
          btn.disabled = false;
          btn.innerHTML = ICON_SEND + ' Telegram orqali kod olish';
        }
      } catch (e) {
        document.getElementById('signup-phone-err').textContent = "Server bilan aloqa yo'q. Qayta urining.";
        btn.disabled = false;
        btn.innerHTML = ICON_SEND + ' Telegram orqali kod olish';
      }
    }

    async function signupVerify() {
      const code = getOtpVal('signup-otp-container');
      if (code.length < 4) { document.getElementById('signup-otp-err').textContent = 'Kodni kiriting'; return; }
      document.getElementById('signup-otp-err').textContent = '';

      const btn = document.getElementById('signup-verify-btn');
      btn.disabled = true; btn.textContent = '‚è≥ Tekshirilmoqda...';

      try {
        const res = await fetch(`${API_URL}/api/otp/verify`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone: verifiedPhone, code, mode: 'signup' })
        });
        const data = await res.json();

        if (res.ok && data.success) {
          if (window.signupTimer) clearInterval(window.signupTimer);
          document.getElementById('firstName').value = data.user?.firstName || '';
          document.getElementById('lastName').value = data.user?.lastName || '';
          document.getElementById('signup-name-err').textContent = '';
          renderSteps('signup', 3);
          showPanel('panel-signup-name');
          setTimeout(() => document.getElementById('firstName').focus(), 300);
        } else {
          document.getElementById('signup-otp-err').textContent = getErrMsg(data) || "Noto'g'ri kod";
          btn.disabled = false; btn.innerHTML = ICON_CHECK + ' Tasdiqlash';
          triggerShake('signup-otp-container');
          clearOtp('signup-otp-container');
          document.querySelector('#signup-otp-container input').focus();
        }
      } catch (e) {
        document.getElementById('signup-otp-err').textContent = "Server bilan aloqa yo'q.";
        btn.disabled = false; btn.innerHTML = ICON_CHECK + ' Tasdiqlash';
        triggerShake('signup-otp-container');
      }
    }

    function signupResend() {
      goHome();
    }

    function saveProfile() {
      const first = document.getElementById('firstName').value.trim();
      const last = document.getElementById('lastName').value.trim();
      if (!first) { document.getElementById('signup-name-err').textContent = "Ismingizni kiriting"; return; }
      if (!last) { document.getElementById('signup-name-err').textContent = "Familyangizni kiriting"; return; }

      fetch(`${API_URL}/api/users/profile`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone: verifiedPhone, firstName: first, lastName: last })
      }).catch(() => { }); // fire and forget ‚Äî localStorage yetarli

      localStorage.setItem('kfc_user', JSON.stringify({
        phone: verifiedPhone, firstName: first, lastName: last,
        registeredAt: new Date().toISOString()
      }));
      localStorage.setItem('kfc_verified_phone', verifiedPhone);
      window.location.href = sessionStorage.getItem('reg_from') || 'index.html';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // LOGIN FLOW
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    async function loginSendOTP() {
      const raw = document.getElementById('login-phone').value.replace(/\D/g, '');
      if (raw.length < 9) {
        document.getElementById('login-phone-err').textContent = "Telefon raqamni to'liq kiriting"; return;
      }
      const phone = '+998' + raw.slice(-9);
      document.getElementById('login-phone-err').textContent = '';
      document.getElementById('login-tgBotMsg').style.display = 'none';

      const btn = document.getElementById('login-send-btn');
      btn.disabled = true; btn.textContent = 'Yuborilmoqda...';

      try {
        const res = await fetch(`${API_URL}/api/otp/send`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone, mode: 'login' })
        });
        const data = await res.json();
        const errMsg = getErrMsg(data);

        if (res.status === 429 || res.ok) {
          verifiedPhone = phone;
          document.getElementById('login-otp-msg').textContent = ` ${phone} uchun Telegram ga kod yuborildi`;
          clearOtp('login-otp-container');
          document.getElementById('login-otp-err').textContent = '';
          document.getElementById('login-verify-btn').disabled = false;
          document.getElementById('login-verify-btn').innerHTML = ICON_CHECK + ' Tasdiqlash';
          renderSteps('login', 2);
          showPanel('panel-login-otp');
          startTimer('loginTimer', 'login-timer', 'login-resend-btn');
          setTimeout(() => document.querySelector('#login-otp-container input').focus(), 300);
        } else if (res.status === 404 && errMsg.includes('user_not_found')) {
          // App da ro'yxatdan o'tmagan ‚Äî ro'yxatdan o'tishga yo'naltirish
          document.getElementById('login-phone-err').innerHTML =
            "<span style='color:#E53935;font-weight:700;'>Bu raqam topilmadi.</span> " +
            "<a href='javascript:void(0)' onclick='goHome()' style='color:#FAB95B;font-weight:700;text-decoration:underline;'>Ro'yxatdan o'tish ‚Üí</a>";
          btn.disabled = false; btn.innerHTML = ICON_SEND + ' Telegram orqali kod olish';
        } else if (res.status === 404 || errMsg.includes('not_registered')) {
          document.getElementById('login-tgBotMsg').style.display = 'block';
          document.getElementById('login-tgBotMsg').scrollIntoView({ behavior: 'smooth' });
          btn.disabled = false; btn.innerHTML = ICON_SEND + ' Telegram orqali kod olish';
        } else {
          document.getElementById('login-phone-err').textContent = errMsg || 'Xato. Qayta urining.';
          btn.disabled = false; btn.innerHTML = ICON_SEND + ' Telegram orqali kod olish';
        }
      } catch (e) {
        document.getElementById('login-phone-err').textContent = "Server bilan aloqa yo'q. Qayta urining.";
        btn.disabled = false; btn.innerHTML = ICON_SEND + ' Telegram orqali kod olish';
      }
    }

    async function loginVerify() {
      const code = getOtpVal('login-otp-container');
      if (code.length < 4) { document.getElementById('login-otp-err').textContent = 'Kodni kiriting'; return; }
      document.getElementById('login-otp-err').textContent = '';

      const btn = document.getElementById('login-verify-btn');
      btn.disabled = true; btn.textContent = '‚è≥ Tekshirilmoqda...';

      try {
        const res = await fetch(`${API_URL}/api/otp/verify`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone: verifiedPhone, code, mode: 'login' })
        });
        const data = await res.json();

        if (res.ok && data.success) {
          if (window.loginTimer) clearInterval(window.loginTimer);
          if (data.user && data.user.firstName) {
            localStorage.setItem('kfc_user', JSON.stringify({
              phone: data.user.phone, firstName: data.user.firstName,
              lastName: data.user.lastName || '', registeredAt: new Date().toISOString()
            }));
            localStorage.setItem('kfc_verified_phone', data.user.phone);
            window.location.replace(sessionStorage.getItem('reg_from') || 'index.html');
          } else {
            document.getElementById('login-otp-err').textContent = 'Xatolik yuz berdi. Qaytadan urining.';
            btn.disabled = false; btn.innerHTML = ICON_CHECK + ' Tasdiqlash';
          }
        } else {
          document.getElementById('login-otp-err').textContent = getErrMsg(data) || "Noto'g'ri kod";
          btn.disabled = false; btn.innerHTML = ICON_CHECK + ' Tasdiqlash';
          triggerShake('login-otp-container');
          clearOtp('login-otp-container');
          document.querySelector('#login-otp-container input').focus();
        }
      } catch (e) {
        document.getElementById('login-otp-err').textContent = "Server bilan aloqa yo'q.";
        btn.disabled = false; btn.innerHTML = ICON_CHECK + ' Tasdiqlash';
        triggerShake('login-otp-container');
      }
    }

    function loginResend() {
      goLoginPhone();
      document.getElementById('login-phone-err').textContent = '';
      document.getElementById('login-tgBotMsg').style.display = 'none';
      document.getElementById('login-send-btn').disabled = false;
      document.getElementById('login-send-btn').innerHTML = ICON_SEND + ' Telegram orqali kod olish';
    }

    function getErrMsg(data) {
      const detail = data?.detail || data;
      if (typeof detail === 'object') return detail?.message || detail?.error || JSON.stringify(detail);
      return String(detail);
    }

    function handleBack() {
      const active = document.querySelector('.step-panel.active');
      if (active && active.id !== 'panel-home') {
        if (active.id === 'panel-login-otp') { goLoginPhone(); return; }
        if (active.id === 'panel-login-phone') { goHome(); return; }
        if (active.id === 'panel-signup-otp') { goHome(); return; }
        if (active.id === 'panel-signup-name') { goHome(); return; }
      }
      history.back();
    }

    function triggerShake(id) {
      const el = document.getElementById(id);
      el.classList.add('shake');
      setTimeout(() => el.classList.remove('shake'), 300);
    }

    document.addEventListener('DOMContentLoaded', function () {
      renderSteps('signup', 1);
      setupOtp('signup-otp-container', signupVerify);
      setupOtp('login-otp-container', loginVerify);
    });

    function setupOtp(containerId, verifyFunc) {
      const container = document.getElementById(containerId);
      const inputs = container.querySelectorAll('input');

      inputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
          e.target.value = e.target.value.replace(/[^0-9]/g, '');
          if (e.target.value.length > 1) e.target.value = e.target.value.slice(-1);
          if (e.target.value) {
            if (index < inputs.length - 1) inputs[index + 1].focus();
            else verifyFunc();
          }
        });
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !e.target.value && index > 0) inputs[index - 1].focus();
        });
        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const data = (e.clipboardData || window.clipboardData).getData('text');
          const digits = data.replace(/\D/g, '').split('').slice(0, 6);
          digits.forEach((d, i) => { if (index + i < inputs.length) inputs[index + i].value = d; });
          const nextIndex = Math.min(index + digits.length, inputs.length - 1);
          inputs[nextIndex].focus();
          if (getOtpVal(containerId).length === 6) verifyFunc();
        });
      });
    }

    function getOtpVal(containerId) {
      const container = document.getElementById(containerId);
      let code = '';
      container.querySelectorAll('input').forEach(i => code += i.value);
      return code;
    }

    function clearOtp(containerId) {
      document.getElementById(containerId).querySelectorAll('input').forEach(i => i.value = '');
    }
  </script>

</body>

</html>